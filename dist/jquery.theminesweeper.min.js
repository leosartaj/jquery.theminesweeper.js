/*! The Minesweeper - v0.1.0 - 2014-04-02
* https://github.com/leosartaj/jquery.theminesweeper.js
* Copyright (c) 2014 Sartaj Singh; Licensed MIT */
!function(a){var b=[{height:8,width:8,mines:10}],c={0:"transparent",1:"blue",2:"green",3:"red",4:"black",5:"black",6:"black",7:"black",8:"black",m:"red",t:"red"};a.widget("ss.theminesweeper",{version:"0.1.0",options:{levels:b,color:c},_create:function(){var a=this.options.levels[0];a.mleft=a.mines,this.element.addClass("ss-minesweeper ui-widget ui-corner-all"),this._createWrapper(),this._createButtons(),this._generateMines(),this._renderMarkup(),this._on({"mousedown button":this._clickHandler})},_createWrapper:function(){var b=a("<div/>"),c=a("<span/>"),d=this.options.levels[0];this.shell=b.clone().addClass("ss-minesweeper-shell ui-widget-header ui-corner-all"),this.display=b.clone().addClass("ss-minesweeper-display ui-corner-all"),this.display.appendTo(this.shell),c.clone().addClass("ss-minesweeper-mines").text(d.mleft).appendTo(this.display),c.clone().addClass("ss-minesweeper-timer").text("0.0").appendTo(this.display)},_createButtons:function(){var b,c=a("<button/>"),d=a("<div/>").addClass("ss-minesweeper-buttons ui-helper-clearfix ui-widget-content ui-corner-all"),e=0,f=this.options.levels[0],g=f.height,h=f.width,i=[];for(f.elapsed=0,f.timer=a.timer(function(){f.elapsed=f.elapsed+.01,a(".ss-minesweeper-timer").text(f.elapsed.toPrecision(3))}),c.clone().addClass("ss-minesweeper-smiley ui-widget-content ui-corner-all").data("r",1).appendTo(this.display).button({label:"Smiley",icons:{primary:"happy-smiley",secondary:null},text:!1}),e=0;h>e;e++)for(i[e]=[],b=0;g>b;b++)i[e][b]=0===b?{label:"s",mine:"n",classname:"ss-minesweeper-left",near:0,active:"y"}:{label:"s",mine:"n",near:0,active:"y"};for(b=0;g>b;b++)for(e=0;h>e;e++){var j=c.clone().text(i[e][b].label).appendTo(d);i[e][b].classname&&j.addClass(i[e][b].classname),j.attr("x",e),j.attr("y",b),j.attr("xy",e+","+b)}f.buttons=i,d.buttonset(),d.appendTo(this.shell),f.left=g*h},_renderMarkup:function(){this.shell.appendTo(this.element),this._setStyle()},_setOptions:function(){this._superApply(arguments)},_setOption:function(b,c){this._super(b,c),"levels"===b?(this.shell.find("button").remove(),this._createButtons(),this._generateMines(),this._renderMarkup()):"color"===b&&(a(".ss-minesweeper-mines").css("color",this.options.color.m),a(".ss-minesweeper-timer").css("color",this.options.color.t))},_generateMines:function(){for(var a,b,c=this.options.levels[0],d=c.mines,e=c.width,f=c.height;0!==d;)a=Math.floor(e*Math.random()),b=Math.floor(f*Math.random()),"n"===c.buttons[a][b].mine&&(c.buttons[a][b].mine="y",this._calNear(a,b),d--)},_clickHandler:function(b){var c,d=a(b.target).closest("button");if(this.options.levels[0].timer.isActive||this.options.levels[0].timer.set({time:10,autostart:!0}),this._changeSmiley("0","1"),1===b.which)if(1===d.data("r"))this._restart();else{if("f"===d.data("f"))return this._setFlag(d),this._changeSmiley("1","0"),0;if(c=this._checkMine(b,d),c===!0)return this.element.find(".ss-minesweeper-buttons button").button("disable").css("opacity","1"),0;if(c===!1)return this.element.find(".ss-minesweeper-buttons button").button("disable").css("opacity","1"),0}else 1===d.data("r")?this._restart():this._setFlag(d);this._changeSmiley("1","0")},_checkMine:function(a,b){var c=this.options.levels[0],d=+b.attr("x"),e=+b.attr("y");return"y"===c.buttons[d][e].mine?(this._showBoard(),this._changeSmiley("1","2"),!1):(this._showRegion(d,e),this._checkWin()?(this._changeSmiley("1","3"),!0):void 0)},_calNear:function(a,b){var c=this.options.levels[0];a-1>-1&&b-1>-1&&c.buttons[a-1][b-1].near++,b-1>-1&&c.buttons[a][b-1].near++,a-1>-1&&c.buttons[a-1][b].near++,b+1<c.height&&a+1<c.width&&c.buttons[a+1][b+1].near++,a+1<c.width&&c.buttons[a+1][b].near++,b+1<c.height&&c.buttons[a][b+1].near++,a+1<c.width&&b-1>-1&&c.buttons[a+1][b-1].near++,a-1>-1&&b+1<c.height&&c.buttons[a-1][b+1].near++},_showBoard:function(){var b,c,d=this.options.levels[0],e=this;d.timer.pause(),a(".ss-minesweeper-buttons button").each(function(){b=+a(this).attr("x"),c=+a(this).attr("y"),"y"===d.buttons[b][c].mine?a(this).button("option","icons",{primary:"mine-smiley",secondary:null}):a(this).find("span").text(d.buttons[b][c].near).css("color",e.options.color[d.buttons[b][c].near])})},_showRegion:function(b,c){var d,e,f,g,h=b+","+c,i=this.options.levels[0],j=i.buttons[b][c],k=a('button[xy="'+h+'"]');if("y"!==j.active)return 0;if(0!==j.near)return"f"===k.data("f")&&this._setFlag(k),k.find("span").text(j.near).css("color",this.options.color[j.near]).css("background","white"),k.button("disable").css("opacity","1"),j.active="n",i.left--,0;for("f"===k.data("f")&&this._setFlag(k),k.find("span").text(j.near).css("color",this.options.color[j.near]).css("background","white"),k.button("disable").css("opacity","1"),j.active="n",i.left--,d=-1;2>d;d++)for(e=-1;2>e;e++)f=+(b+d),g=+(c+e),f>-1&&f<i.width&&g>-1&&g<i.height&&this._showRegion(f,g)},_checkWin:function(){var a=this.options.levels[0];return a.left===a.mines?(a.timer.pause(),!0):!1},_setFlag:function(b){var c=this.options.levels[0];"f"===b.data("f")?(c.mleft++,b.button("option","icons",{primary:null,secondary:null}),b.data("f","")):0!==c.mleft&&(c.mleft--,b.button("option","icons",{primary:"flag-smiley",secondary:null}),b.data("f","f")),a(".ss-minesweeper-mines").text(c.mleft)},_setStyle:function(){var b=a(".ss-minesweeper-display").css("padding-left");this.element.find(".ss-minesweeper-buttons button").css("width","45").css("float","left").css("color","transparent"),a(".ss-minesweeper-display").css("position","relative"),a(".ss-minesweeper-smiley").css("position","relative").css("top","50%").css("left","45%"),a(".ss-minesweeper-mines").css("color",this.options.color.m).css("padding-right","1em").css("float","right"),a(".ss-minesweeper-timer").css("color",this.options.color.t).css("left",b).css("padding-left","1em").css("float","left").css("position","absolute"),a(".ss-minesweeper-left").css("clear","left"),a(".ss-minesweeper-buttons").masonry({itemSelector:"button",isFitWidth:!0,columnWidth:"button"})},_restart:function(){var b=this.element,c=this.options.levels[0];c.mleft=c.mines,b.find(".ss-minesweeper-buttons").remove(),a(".ss-minesweeper-smiley").remove(),a(".ss-minesweeper-mines").text(c.mleft),c.timer.stop(),c.elapsed=0,a(".ss-minesweeper-timer").text("0.0"),this._createButtons(),this._renderMarkup(),this._generateMines()},_changeSmiley:function(b,c){var d=["happy-smiley","check-smiley","sad-smiley","cool-smiley"];a("."+d[+b]).removeClass(d[+b]).addClass(d[+c])}})}(jQuery);